<!-- forgot-password.html -->
<div class="login-wrapper">
  <!-- Popup Alert -->
  <div *ngIf="showAlert" class="alert-popup" [ngClass]="alertType">
    <div class="alert-content">
      <div class="alert-icon">
        <i *ngIf="alertType === 'success'" class="fas fa-check"></i>
        <i *ngIf="alertType === 'error'" class="fas fa-times"></i>
        <i *ngIf="alertType === 'warning'" class="fas fa-exclamation-triangle"></i>
      </div>
      <p class="alert-message">{{ alertMessage }}</p>
      <button class="alert-close" (click)="closeAlert()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Forgot Password Container -->
  <div class="login-container">
    <div class="login-card">
      <!-- Header -->
      <div class="login-header">
        <h1 class="login-title">EshareBook Admin</h1>
        <p class="login-subtitle">
          <span *ngIf="currentStep === 1">Reset your password</span>
          <span *ngIf="currentStep === 2">Verify your email</span>
          <span *ngIf="currentStep === 3">Create new password</span>
        </p>
      </div>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step-dots">
          <div class="step-dot" [class.active]="currentStep >= 1"></div>
          <div class="step-line" [class.active]="currentStep >= 2"></div>
          <div class="step-dot" [class.active]="currentStep >= 2"></div>
          <div class="step-line" [class.active]="currentStep >= 3"></div>
          <div class="step-dot" [class.active]="currentStep >= 3"></div>
        </div>
      </div>

      <!-- Step 1: Email Form -->
      <form *ngIf="currentStep === 1" [formGroup]="emailForm" (ngSubmit)="onSendCode()">
        <p class="step-description">
          Enter your email address and we'll send you a verification code to reset your password.
        </p>

        <div class="form-container">
          <div class="form-group">
            <label class="form-label">Email Address <span class="required">*</span></label>
            <input
              type="email"
              class="form-control"
              [ngClass]="{ 'is-invalid': isFieldInvalid(emailForm, 'email') }"
              formControlName="email"
              placeholder="admin@example.com"
              (blur)="markAsTouched(emailForm, 'email')"
            />
            <div class="error-message" *ngIf="isFieldInvalid(emailForm, 'email')">
              {{ getErrorMessage(emailForm, 'email') }}
            </div>
          </div>
        </div>

        <div class="submit-container">
          <button type="submit" class="btn-submit" [disabled]="loading">
            <span *ngIf="!loading">Send Verification Code</span>
            <span *ngIf="loading" class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Loading...
            </span>
          </button>
        </div>

        <div class="login-footer">
          <a class="back-link" (click)="goToLogin()">Back to Login</a>
        </div>
      </form>

      <!-- Step 2: Verification Code Form -->
      <form *ngIf="currentStep === 2" [formGroup]="codeForm" (ngSubmit)="onVerifyCode()">
        <p class="step-description">
          We've sent a 6-digit verification code to <strong>{{ userEmail }}</strong>. Please enter it below.
        </p>

        <div class="form-container">
          <div class="form-group">
            <label class="form-label">Verification Code <span class="required">*</span></label>
            <input
              type="text"
              class="form-control code-input"
              [ngClass]="{ 'is-invalid': isFieldInvalid(codeForm, 'code') }"
              formControlName="code"
              placeholder="123456"
              maxlength="6"
              (blur)="markAsTouched(codeForm, 'code')"
            />
            <div class="error-message" *ngIf="isFieldInvalid(codeForm, 'code')">
              {{ getErrorMessage(codeForm, 'code') }}
            </div>
          </div>
        </div>

        <div class="submit-container">
          <button type="submit" class="btn-submit" [disabled]="loading">
            <span *ngIf="!loading">Verify Code</span>
            <span *ngIf="loading" class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Loading...
            </span>
          </button>
        </div>

        <div class="login-footer">
          <a class="back-link" (click)="resendCode()">Resend Code</a>
        </div>
      </form>

      <!-- Step 3: New Password Form -->
      <form *ngIf="currentStep === 3" [formGroup]="passwordForm" (ngSubmit)="onResetPassword()">
        <p class="step-description">Create a strong new password for your account.</p>

        <div class="form-container">
          <!-- New Password -->
          <div class="form-group">
            <label class="form-label">New Password <span class="required">*</span></label>
            <div class="password-wrapper">
              <input
                [type]="showPassword ? 'text' : 'password'"
                class="form-control"
                [ngClass]="{ 'is-invalid': isFieldInvalid(passwordForm, 'newPassword') }"
                formControlName="newPassword"
                placeholder="Enter new password"
                (blur)="markAsTouched(passwordForm, 'newPassword')"
              />
              <button type="button" class="password-toggle" (click)="togglePassword()">
                <i [class]="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
              </button>
            </div>

            <!-- Password Strength Indicator -->
            <div class="password-strength" *ngIf="passwordForm.get('newPassword')?.value">
              <div class="strength-bars">
                <div class="strength-bar"
                     *ngFor="let i of [1,2,3,4]"
                     [ngClass]="i <= getPasswordStrength().strength ? getPasswordStrength().color : ''">
                </div>
              </div>
              <span class="strength-label">{{ getPasswordStrength().label }}</span>
            </div>

            <div class="error-message" *ngIf="isFieldInvalid(passwordForm, 'newPassword')">
              {{ getErrorMessage(passwordForm, 'newPassword') }}
            </div>
          </div>

          <!-- Confirm Password -->
          <div class="form-group">
            <label class="form-label">Confirm Password <span class="required">*</span></label>
            <div class="password-wrapper">
              <input
                [type]="showConfirmPassword ? 'text' : 'password'"
                class="form-control"
                [ngClass]="{ 'is-invalid': isFieldInvalid(passwordForm, 'confirmPassword') || passwordForm.errors?.['passwordMismatch'] }"
                formControlName="confirmPassword"
                placeholder="Confirm new password"
                (blur)="markAsTouched(passwordForm, 'confirmPassword')"
              />
              <button type="button" class="password-toggle" (click)="toggleConfirmPassword()">
                <i [class]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
              </button>
            </div>
            <div class="error-message" *ngIf="isFieldInvalid(passwordForm, 'confirmPassword') || (passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmPassword')?.touched)">
              {{ getErrorMessage(passwordForm, 'confirmPassword') }}
              <span *ngIf="passwordForm.errors?.['passwordMismatch'] && !getErrorMessage(passwordForm, 'confirmPassword')">Passwords do not match</span>
            </div>
          </div>
        </div>

        <div class="submit-container">
          <button type="submit" class="btn-submit" [disabled]="loading">
            <span *ngIf="!loading">Reset Password</span>
            <span *ngIf="loading" class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i> Loading...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
