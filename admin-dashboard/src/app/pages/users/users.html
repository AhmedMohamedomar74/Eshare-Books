<div class="users-page">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">User Management</h1>
    <p class="page-subtitle">Manage all registered users in the system.</p>
  </div>

  <!-- LOADING & ERROR STATES -->
  <div *ngIf="loading && !searchLoading" class="alert alert-info">
    <i class="bi bi-hourglass-split"></i> Loading users...
  </div>

  <div *ngIf="error && !loading" class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
    <button class="btn btn-sm btn-outline-secondary ms-2" (click)="loadUsers()">
      <i class="bi bi-arrow-clockwise"></i> Retry
    </button>
  </div>

  <!-- Search & Filters -->
  <div class="search-filter-bar">
    <div class="search-box">
      <i class="bi bi-search"></i>
      <input
        type="text"
        class="form-control"
        placeholder="Search by name, email, or ID..."
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
        [disabled]="loading && !searchLoading"
      />
      <!-- Search Loading Spinner -->
      <span *ngIf="searchLoading" class="search-spinner">
        <span class="spinner-border spinner-border-sm text-primary"></span>
      </span>
    </div>

    <div class="filter-group">
      <select
        class="filter-select"
        [(ngModel)]="sortBy"
        (change)="onSortChange()"
        [disabled]="loading && !searchLoading"
      >
        <option value="name">Sort by: Name</option>
        <option value="email">Sort by: Email</option>
        <option value="role">Sort by: Role</option>
        <option value="date">Sort by: Date</option>
      </select>

      <select
        class="filter-select"
        [(ngModel)]="roleFilter"
        (change)="onRoleFilter()"
        [disabled]="loading && !searchLoading"
      >
        <option value="all">Role: All</option>
        <option value="admin">Role: Admin</option>
        <option value="user">Role: User</option>
      </select>

      <select
        class="filter-select"
        [(ngModel)]="statusFilter"
        (change)="onStatusFilter()"
        [disabled]="loading && !searchLoading"
      >
        <option value="all">Status: All</option>
        <option value="confirmed">Status: Confirmed</option>
        <option value="pending">Status: Pending</option>
      </select>

      <!-- Clear Filters Button -->
      <button
        class="btn btn-outline-danger btn-sm"
        (click)="clearFilters()"
        [disabled]="loading || (!searchTerm && roleFilter === 'all' && statusFilter === 'all')"
      >
        <i class="bi bi-x-circle"></i> Clear
      </button>
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-container" *ngIf="!loading">
    <table class="table user-table">
      <thead>
        <tr>
          <th>PROFILE PIC</th>
          <th>NAME</th>
          <th>EMAIL</th>
          <th>ROLE</th>
          <th>STATUS</th>
          <th>JOINED DATE</th>
          <th class="text-center">ACTIONS</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of paginatedUsers">
          <td>
            <img
              [src]="user.profilePic || '/default-admin.png'"
              [alt]="user.firstName"
              class="profile-pic"
            />
          </td>
          <td>
            <div class="user-name">
              <i class="bi bi-person-circle me-1"></i>
              {{ getUserFullName(user) }}
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
              {{ user.role | titlecase }}
            </span>
          </td>
          <td>
            <span class="badge" [ngClass]="getStatusBadgeClass(user.isConfirmed)">
              <i
                class="bi"
                [class.bi-check-circle-fill]="user.isConfirmed"
                [class.bi-clock-fill]="!user.isConfirmed"
              ></i>
              {{ user.isConfirmed ? 'Confirmed' : 'Pending' }}
            </span>
          </td>
          <td>{{ user.createdAt | date : 'mediumDate' }}</td>
          <td class="text-center">
            <div class="action-buttons">
              <!-- Confirm User Button (only for unconfirmed users) -->
              <button
                *ngIf="!user.isConfirmed"
                class="btn btn-sm btn-link text-success p-0"
                (click)="openConfirmModal(user)"
                [disabled]="loading"
                title="Confirm User"
              >
                <i class="bi bi-check-lg"></i>
              </button>

              <!-- Delete User Button (only for non-admin users) -->
              <button
                *ngIf="user.role !== 'admin'"
                class="btn btn-sm btn-link text-danger p-0"
                (click)="openDeleteModal(user)"
                [disabled]="loading"
                title="Delete User"
              >
                <i class="bi bi-trash"></i>
              </button>

              <!-- Admin users message -->
              <span *ngIf="user.role === 'admin'" class="text-muted small"></span>
            </div>
          </td>
        </tr>

        <!-- Empty State -->
        <tr *ngIf="!loading && paginatedUsers.length === 0">
          <td colspan="7" class="text-center py-5">
            <div class="empty-state">
              <i class="bi bi-people display-1 text-muted d-block mb-3"></i>
              <h5 class="text-muted">No users found</h5>
              <p class="text-muted small">Try adjusting your filters or search query</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination-wrapper" *ngIf="totalResults > 0">
      <div class="pagination-info">
        Showing {{ startIndex }} to {{ endIndex }} of {{ totalResults }} results
      </div>
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <!-- Previous Button -->
          <li class="page-item" [class.disabled]="currentPage === 1 || loading">
            <a
              class="page-link"
              href="javascript:void(0)"
              (click)="previousPage()"
              aria-label="Previous"
            >
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>

          <!-- Page Numbers -->
          <li
            class="page-item"
            *ngFor="let page of visiblePages"
            [class.active]="page === currentPage"
            [class.disabled]="page === '...'"
          >
            <a class="page-link" href="javascript:void(0)" (click)="goToPage(page)">
              {{ page }}
            </a>
          </li>

          <!-- Next Button -->
          <li class="page-item" [class.disabled]="isLastPage() || loading">
            <a class="page-link" href="javascript:void(0)" (click)="nextPage()" aria-label="Next">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div
    *ngIf="showToastMessage"
    class="toast-notification"
    [ngClass]="toastType === 'success' ? 'toast-success' : 'toast-error'"
  >
    <i
      class="bi"
      [class.bi-check-circle-fill]="toastType === 'success'"
      [class.bi-exclamation-circle-fill]="toastType === 'error'"
    ></i>
    {{ toastMessage }}
  </div>

  <!-- CONFIRM USER MODAL -->
  <div
    *ngIf="showConfirmModal"
    class="modal-overlay"
    (click)="!modalLoading && closeConfirmModal()"
  >
    <div class="modal-content" (click)="$event.stopPropagation()" [class.loading]="modalLoading">
      <div class="modal-header">
        <h5>
          <i class="bi bi-check-circle text-success"></i>
          Confirm User
        </h5>
        <button class="btn-close" (click)="closeConfirmModal()" [disabled]="modalLoading"></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to confirm
          <strong>{{ userForConfirmation?.firstName }} {{ userForConfirmation?.secondName }}</strong
          >?
        </p>
        <p class="text-muted small">
          <i class="bi bi-info-circle"></i>
          This will allow the user to access all system features.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeConfirmModal()" [disabled]="modalLoading">
          Cancel
        </button>
        <button class="btn btn-success" (click)="confirmUser()" [disabled]="modalLoading">
          <span *ngIf="modalLoading" class="loading-spinner">
            <span class="spinner-border spinner-border-sm"></span>
            Confirming...
          </span>
          <span *ngIf="!modalLoading">
            <i class="bi bi-check-lg"></i>
            Confirm
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- DELETE USER MODAL -->
  <div *ngIf="showDeleteModal" class="modal-overlay" (click)="!modalLoading && closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" [class.loading]="modalLoading">
      <div class="modal-header">
        <h5>
          <i class="bi bi-trash text-danger"></i>
          Delete User
        </h5>
        <button class="btn-close" (click)="closeDeleteModal()" [disabled]="modalLoading"></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete
          <strong>{{ userForDeletion?.firstName }} {{ userForDeletion?.secondName }}</strong
          >?
        </p>
        <p class="text-muted small">
          <i class="bi bi-exclamation-triangle text-danger"></i>
          This action will delete all user data including books and operations. This action cannot
          be undone.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteModal()" [disabled]="modalLoading">
          Cancel
        </button>
        <button class="btn btn-danger" (click)="confirmDelete()" [disabled]="modalLoading">
          <span *ngIf="modalLoading" class="loading-spinner">
            <span class="spinner-border spinner-border-sm"></span>
            Deleting...
          </span>
          <span *ngIf="!modalLoading">
            <i class="bi bi-trash"></i>
            Delete
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
